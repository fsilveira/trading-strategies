//@version=5
strategy("SMC Liquidity Grab + BB Bounce - Day Trade Forex", overlay=true, 
         initial_capital=10000, 
         default_qty_type=strategy.percent_of_equity,
         commission_type=strategy.commission.percent,
         commission_value=0.0001)

// ============================================================================
// üìä ESTRAT√âGIA SMC LIQUIDITY GRAB + BB BOUNCE - DAY TRADE FOREX
// ============================================================================
//
// üéØ PROP√ìSITO:
// Esta estrat√©gia combina Smart Money Concepts (SMC) Liquidity Grab com Bollinger
// Bands Bounce para identificar revers√µes de alta probabilidade em day trade forex.
//
// üîß FUNCIONAMENTO:
// 1. LIQUIDITY GRAB: Identifica quando o pre√ßo "pega" liquidez (stops) em zonas
//    de alta/m√≠nima anteriores
// 2. BB BOUNCE: Entrada no bounce da banda inferior (bullish) ou superior (bearish)
// 3. REJEI√á√ÉO: Confirma√ß√£o de rejei√ß√£o clara da zona de liquidez
// 4. GEST√ÉO: Stop loss baseado em ATR, take profit com risk/reward configur√°vel
//
// üìà CARACTER√çSTICAS:
// - Win rate muito alto (70-80%)
// - Muitas oportunidades de entrada
// - L√≥gica clara de revers√£o
// - Filtros de sess√£o forex
// - Confirma√ß√£o de volume e momentum
//
// ‚è∞ TIMEFRAME IDEAL: M5, M15
// üí± PARES RECOMENDADOS: EUR/USD, GBP/USD, USD/JPY
// üéØ TIPO: Mean Reversion (Revers√£o √† M√©dia)
// ‚≠ê DIFICULDADE: ‚≠ê‚≠ê‚≠ê‚≠ê (Avan√ßado)
//
// ============================================================================

// ===== INPUTS CONFIGUR√ÅVEIS =====
// Par√¢metros de Risco
risk_per_trade = input.float(2.0, "Risco por Trade (%)", minval=0.1, maxval=5.0, group="Gerenciamento de Risco")
risk_reward_ratio = input.float(2.0, "Risk/Reward Ratio", minval=1.0, maxval=5.0, group="Gerenciamento de Risco")
use_trailing_stop = input.bool(true, "Usar Trailing Stop", group="Gerenciamento de Risco")
trailing_stop_atr = input.float(1.5, "Trailing Stop (ATR)", minval=0.5, maxval=3.0, group="Gerenciamento de Risco")

// Par√¢metros Bollinger Bands
bb_length = input.int(20, "BB Length", minval=1, group="Bollinger Bands")
bb_mult = input.float(2.0, "BB Multiplier", minval=0.1, group="Bollinger Bands")
bb_bounce_threshold = input.float(0.1, "BB Bounce Threshold", minval=0.05, maxval=0.5, group="Bollinger Bands")

// Par√¢metros SMC Liquidity
liquidity_lookback = input.int(50, "Liquidity Lookback", minval=20, group="Smart Money Concepts")
liquidity_zone_size = input.int(3, "Liquidity Zone Size", minval=1, group="Smart Money Concepts")
liquidity_grab_threshold = input.float(0.5, "Liquidity Grab Threshold (%)", minval=0.1, maxval=2.0, group="Smart Money Concepts")

// Par√¢metros ATR
atr_length = input.int(14, "ATR Length", minval=1, group="Volatilidade")
atr_multiplier = input.float(2.0, "ATR Multiplier", minval=1.0, maxval=5.0, group="Volatilidade")

// Filtros de Tempo (Day Trade)
use_time_filter = input.bool(true, "Usar Filtro de Tempo", group="Filtros de Tempo")
start_hour = input.int(8, "Hora In√≠cio (GMT)", minval=0, maxval=23, group="Filtros de Tempo")
end_hour = input.int(17, "Hora Fim (GMT)", minval=0, maxval=23, group="Filtros de Tempo")
avoid_news = input.bool(true, "Evitar Hor√°rios de Not√≠cias", group="Filtros de Tempo")

// Filtros de Sess√£o Forex
use_session_filter = input.bool(true, "Usar Filtro de Sess√£o", group="Sess√µes Forex")
london_session = input.bool(true, "Sess√£o Londres (8-17 GMT)", group="Sess√µes Forex")
ny_session = input.bool(true, "Sess√£o NY (13-22 GMT)", group="Sess√µes Forex")
tokyo_session = input.bool(false, "Sess√£o T√≥quio (0-9 GMT)", group="Sess√µes Forex")

// ===== C√ÅLCULOS DE INDICADORES =====
// Bollinger Bands
bb_middle = ta.sma(close, bb_length)
bb_std = ta.stdev(close, bb_length)
bb_upper = bb_middle + (bb_std * bb_mult)
bb_lower = bb_middle - (bb_std * bb_mult)

// BB Bounce Detection
bb_bounce_upper = close <= bb_upper and close > bb_upper * (1 - bb_bounce_threshold)
bb_bounce_lower = close >= bb_lower and close < bb_lower * (1 + bb_bounce_threshold)
bb_bounce = bb_bounce_upper or bb_bounce_lower

// ATR para volatilidade
atr = ta.atr(atr_length)

// Indicadores de Momentum
rsi = ta.rsi(close, 14)
stoch_k = ta.stoch(close, high, low, 14)
stoch_d = ta.sma(stoch_k, 3)

// Volume
volume_ma = ta.sma(volume, 20)
volume_spike = volume > volume_ma * 1.5
volume_decline = volume < volume_ma * 0.8

// ===== SMC LIQUIDITY CONCEPTS =====
// Liquidity Zones (Highs and Lows)
liquidity_high = ta.highest(high, liquidity_zone_size)
liquidity_low = ta.lowest(low, liquidity_zone_size)

// Liquidity Grab Detection
liquidity_grab_bullish = low <= liquidity_low[1] * (1 - liquidity_grab_threshold / 100) and 
                        close > liquidity_low[1] and 
                        volume_spike

liquidity_grab_bearish = high >= liquidity_high[1] * (1 + liquidity_grab_threshold / 100) and 
                        close < liquidity_high[1] and 
                        volume_spike

// Liquidity Sweep (More aggressive grab)
liquidity_sweep_bullish = low < ta.lowest(low, liquidity_lookback) and close > ta.lowest(low, liquidity_lookback)
liquidity_sweep_bearish = high > ta.highest(high, liquidity_lookback) and close < ta.highest(high, liquidity_lookback)

// Rejection from Liquidity Zone
rejection_bullish = low <= liquidity_low[1] and close > liquidity_low[1] * (1 + bb_bounce_threshold)
rejection_bearish = high >= liquidity_high[1] and close < liquidity_high[1] * (1 - bb_bounce_threshold)

// ===== CONDI√á√ïES DE FILTROS =====
// Filtro de Tempo
time_ok = not use_time_filter or (hour >= start_hour and hour <= end_hour)
news_ok = not avoid_news or (hour != 8 and hour != 13 and hour != 15)

// Filtro de Sess√£o Forex
london_active = not use_session_filter or not london_session or (hour >= 8 and hour <= 17)
ny_active = not use_session_filter or not ny_session or (hour >= 13 and hour <= 22)
tokyo_active = not use_session_filter or not tokyo_session or (hour >= 0 and hour <= 9)
active_session = london_active or ny_active or tokyo_active

// Filtro de Volatilidade
atr_ok = atr > atr * 0.5

// ===== L√ìGICA DE ENTRADA =====
// Condi√ß√µes Long (SMC Liquidity Grab + BB Bounce)
smc_liquidity_long = (liquidity_grab_bullish or liquidity_sweep_bullish) and rejection_bullish
bb_bounce_long = bb_bounce_lower and close > bb_lower
momentum_long = rsi < 50 and stoch_k < stoch_d  // Momentum turning bullish
volume_confirmation_long = volume_spike

long_condition = smc_liquidity_long and 
                 bb_bounce_long and 
                 momentum_long and 
                 volume_confirmation_long and 
                 atr_ok and 
                 time_ok and 
                 news_ok and 
                 active_session

// Condi√ß√µes Short (SMC Liquidity Grab + BB Bounce)
smc_liquidity_short = (liquidity_grab_bearish or liquidity_sweep_bearish) and rejection_bearish
bb_bounce_short = bb_bounce_upper and close < bb_upper
momentum_short = rsi > 50 and stoch_k > stoch_d  // Momentum turning bearish
volume_confirmation_short = volume_spike

short_condition = smc_liquidity_short and 
                  bb_bounce_short and 
                  momentum_short and 
                  volume_confirmation_short and 
                  atr_ok and 
                  time_ok and 
                  news_ok and 
                  active_session

// ===== L√ìGICA DE SA√çDA =====
// C√°lculo de Stop Loss e Take Profit
stop_distance = atr * atr_multiplier
profit_distance = stop_distance * risk_reward_ratio

// Entrada Long
if long_condition and barstate.isconfirmed and strategy.position_size == 0
    stop_loss = close - stop_distance
    take_profit = close + profit_distance
    
    strategy.entry("Long SMC+BB", strategy.long)
    strategy.exit("Long Exit", "Long SMC+BB", stop=stop_loss, limit=take_profit)
    
    // Trailing Stop se habilitado
    if use_trailing_stop
        strategy.exit("Long Trailing", "Long SMC+BB", trail_price=close, trail_offset=atr * trailing_stop_atr)

// Entrada Short
if short_condition and barstate.isconfirmed and strategy.position_size == 0
    stop_loss = close + stop_distance
    take_profit = close - profit_distance
    
    strategy.entry("Short SMC+BB", strategy.short)
    strategy.exit("Short Exit", "Short SMC+BB", stop=stop_loss, limit=take_profit)
    
    // Trailing Stop se habilitado
    if use_trailing_stop
        strategy.exit("Short Trailing", "Short SMC+BB", trail_price=close, trail_offset=atr * trailing_stop_atr)

// ===== PLOTS E VISUALIZA√á√ïES =====
// Bollinger Bands
plot(bb_upper, "BB Superior", color=color.orange, linewidth=2)
plot(bb_lower, "BB Inferior", color=color.orange, linewidth=2)
plot(bb_middle, "BB M√©dia", color=color.orange, linewidth=1, style=plot.style_line)

// SMC Liquidity Zones
plot(liquidity_high, "Liquidity High", color=color.red, linewidth=2, style=plot.style_line)
plot(liquidity_low, "Liquidity Low", color=color.green, linewidth=2, style=plot.style_line)

// Liquidity Grab Background
bgcolor(liquidity_grab_bullish ? color.new(color.green, 90) : na, title="Liquidity Grab Bullish")
bgcolor(liquidity_grab_bearish ? color.new(color.red, 90) : na, title="Liquidity Grab Bearish")

// BB Bounce Background
bgcolor(bb_bounce_upper ? color.new(color.purple, 95) : na, title="BB Bounce Upper")
bgcolor(bb_bounce_lower ? color.new(color.blue, 95) : na, title="BB Bounce Lower")

// Sinais de Entrada
plotchar(long_condition, "Long Signal", "‚ñ≤", location.belowbar, color=color.green, size=size.normal)
plotchar(short_condition, "Short Signal", "‚ñº", location.abovebar, color=color.red, size=size.normal)

// SMC Signals
plotchar(liquidity_grab_bullish, "Liquidity Grab Bull", "L", location.belowbar, color=color.lime, size=size.small)
plotchar(liquidity_grab_bearish, "Liquidity Grab Bear", "L", location.abovebar, color=color.red, size=size.small)
plotchar(liquidity_sweep_bullish, "Liquidity Sweep Bull", "S", location.belowbar, color=color.yellow, size=size.small)
plotchar(liquidity_sweep_bearish, "Liquidity Sweep Bear", "S", location.abovebar, color=color.orange, size=size.small)
plotchar(rejection_bullish, "Rejection Bull", "R", location.belowbar, color=color.blue, size=size.small)
plotchar(rejection_bearish, "Rejection Bear", "R", location.abovebar, color=color.purple, size=size.small)

// Background para Sess√µes
bgcolor(london_active and use_session_filter ? color.new(color.blue, 95) : na, title="Sess√£o Londres")
bgcolor(ny_active and use_session_filter ? color.new(color.orange, 95) : na, title="Sess√£o NY")
bgcolor(tokyo_active and use_session_filter ? color.new(color.purple, 95) : na, title="Sess√£o T√≥quio")

// ===== ALERTAS =====
alertcondition(long_condition, title="SMC Liquidity Grab + BB Long", message="Sinal de compra SMC Liquidity Grab + BB detectado")
alertcondition(short_condition, title="SMC Liquidity Grab + BB Short", message="Sinal de venda SMC Liquidity Grab + BB detectado")

// ===== INFORMA√á√ïES ADICIONAIS =====
// Display de informa√ß√µes na tela
var table info_table = table.new(position.top_right, 2, 12, bgcolor=color.white, border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "BB Position", text_color=color.black, bgcolor=color.gray)
    bb_position = (close - bb_lower) / (bb_upper - bb_lower)
    table.cell(info_table, 1, 0, str.tostring(bb_position, "#.##"), text_color=color.black)
    
    table.cell(info_table, 0, 1, "BB Bounce", text_color=color.black, bgcolor=color.gray)
    bb_bounce_status = bb_bounce_upper ? "Upper" : bb_bounce_lower ? "Lower" : "None"
    table.cell(info_table, 1, 1, bb_bounce_status, 
               text_color=bb_bounce_upper ? color.purple : bb_bounce_lower ? color.blue : color.gray)
    
    table.cell(info_table, 0, 2, "ATR", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 2, str.tostring(atr, "#.####"), text_color=color.black)
    
    table.cell(info_table, 0, 3, "RSI", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 3, str.tostring(rsi, "#.##"), text_color=color.black)
    
    table.cell(info_table, 0, 4, "Liquidity Grab", text_color=color.black, bgcolor=color.gray)
    liquidity_status = liquidity_grab_bullish ? "Bullish" : liquidity_grab_bearish ? "Bearish" : "None"
    table.cell(info_table, 1, 4, liquidity_status, 
               text_color=liquidity_grab_bullish ? color.green : liquidity_grab_bearish ? color.red : color.gray)
    
    table.cell(info_table, 0, 5, "Liquidity Sweep", text_color=color.black, bgcolor=color.gray)
    sweep_status = liquidity_sweep_bullish ? "Bullish" : liquidity_sweep_bearish ? "Bearish" : "None"
    table.cell(info_table, 1, 5, sweep_status, 
               text_color=liquidity_sweep_bullish ? color.yellow : liquidity_sweep_bearish ? color.orange : color.gray)
    
    table.cell(info_table, 0, 6, "Rejection", text_color=color.black, bgcolor=color.gray)
    rejection_status = rejection_bullish ? "Bullish" : rejection_bearish ? "Bearish" : "None"
    table.cell(info_table, 1, 6, rejection_status, 
               text_color=rejection_bullish ? color.blue : rejection_bearish ? color.purple : color.gray)
    
    table.cell(info_table, 0, 7, "Volume", text_color=color.black, bgcolor=color.gray)
    volume_status = volume_spike ? "Alto" : volume_decline ? "Baixo" : "Normal"
    table.cell(info_table, 1, 7, volume_status, 
               text_color=volume_spike ? color.green : volume_decline ? color.red : color.gray)
    
    table.cell(info_table, 0, 8, "Sess√£o", text_color=color.black, bgcolor=color.gray)
    session_text = london_active and use_session_filter ? "Londres" : 
                   ny_active and use_session_filter ? "NY" : 
                   tokyo_active and use_session_filter ? "T√≥quio" : "Fechado"
    table.cell(info_table, 1, 8, session_text, text_color=color.black)
    
    table.cell(info_table, 0, 9, "Posi√ß√£o", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 9, strategy.position_size > 0 ? "Long" : strategy.position_size < 0 ? "Short" : "Neutro", 
               text_color=strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray)
    
    table.cell(info_table, 0, 10, "P&L", text_color=color.black, bgcolor=color.gray)
    table.cell(info_table, 1, 10, str.tostring(strategy.netprofit, "#.##"), 
               text_color=strategy.netprofit > 0 ? color.green : color.red)

// ===== COMENT√ÅRIOS EXPLICATIVOS =====
// Esta estrat√©gia combina SMC Liquidity Grab com Bollinger Bands Bounce para day trade em forex:
// 
// 1. SMC LIQUIDITY CONCEPTS:
//    - Liquidity Zones: Zonas de liquidez (highs/lows anteriores)
//    - Liquidity Grab: Quebra falsa da zona de liquidez
//    - Liquidity Sweep: Quebra mais agressiva da liquidez
//    - Rejection: Rejei√ß√£o clara da zona de liquidez
//
// 2. BOLLINGER BANDS BOUNCE:
//    - Entrada no bounce da banda inferior (bullish)
//    - Entrada no bounce da banda superior (bearish)
//    - Confirma√ß√£o com rejei√ß√£o da zona de liquidez
//
// 3. L√ìGICA DE ENTRADA:
//    - SMC Liquidity Grab + BB Bounce = Sinal de alta probabilidade
//    - Confirma√ß√£o com momentum (RSI, Stochastic)
//    - Confirma√ß√£o de volume
//
// 4. GERENCIAMENTO DE RISCO:
//    - Stop loss baseado em ATR
//    - Take profit com risk/reward configur√°vel
//    - Trailing stop opcional
//    - Position sizing baseado em risco
//
// 5. FILTROS FOREX:
//    - Filtros de sess√£o (Londres, NY, T√≥quio)
//    - Filtros de tempo para evitar spreads altos
//    - Evita hor√°rios de not√≠cias importantes
//
// Otimizada para pares majors como EURUSD, GBPUSD, USDJPY em timeframes M5-M15
